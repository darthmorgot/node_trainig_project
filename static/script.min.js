"use strict";window.GameConstants={Fireball:{size:window.fireballSize||24,speed:window.getFireballSpeed||function(e){return e?2:5}},Wizard:{speed:window.wizardSpeed||2,width:window.wizardWidth||61,getHeight:window.getWizardHeight||function(e){return 1.377*e},getX:window.getWizardX||function(e){return e/3},getY:window.getWizardY||function(e){return e-100}}},window.Game=function(){var e=300,t=700,n=0,i=["Кекс","Катя","Игорь"],s=[n][0],r=0,a=1,o=0,d=1,c=1,l=2,u=4,h=8,f={},w="-reversed";f[r]={width:61,height:84,url:"img/wizard.gif"},f[r+w]={width:61,height:84,url:"img/wizard-reversed.gif"},f[a]={width:24,height:24,url:"img/fireball.gif"};var m={};m[r]=function(n,i,s){i.keysPressed.UP&&n.y>0&&(n.direction=n.direction&~h,n.direction=n.direction|u,n.y-=n.speed*s*2),i.keysPressed.UP||n.y<e-n.height&&(n.direction=n.direction&~u,n.direction=n.direction|h,n.y+=n.speed*s/3),i.keysPressed.LEFT&&(n.direction=n.direction&~l,n.direction=n.direction|c,n.x-=n.speed*s),i.keysPressed.RIGHT&&(n.direction=n.direction&~c,n.direction=n.direction|l,n.x+=n.speed*s),n.y<0&&(n.y=0),n.y>e-n.height&&(n.y=e-n.height),n.x<0&&(n.x=0),n.x>t-n.width&&(n.x=t-n.width)},m[a]=function(e,n,i){e.direction&c&&(e.x-=e.speed*i),e.direction&l&&(e.x+=e.speed*i),(e.x<0||e.x>t)&&(e.state=d)};var v={CONTINUE:0,WIN:1,FAIL:2,PAUSE:3,INTRO:4},y={};y[n]=function(e){return e.garbage.filter(function(e){return e.type===a}).filter(function(e){return e.x<10&&e.y>240})[0]?v.WIN:v.CONTINUE};var p={};p[n]=function(n){return n.objects.push({direction:l,height:window.GameConstants.Wizard.getHeight(window.GameConstants.Wizard.width),speed:window.GameConstants.Wizard.speed,sprite:f[r],state:o,type:r,width:window.GameConstants.Wizard.width,x:window.GameConstants.Wizard.getX(t),y:window.GameConstants.Wizard.getY(e)}),n};var g=function(e){this.container=e,this.canvas=document.createElement("canvas"),this.canvas.width=e.clientWidth,this.canvas.height=e.clientHeight,this.container.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d"),this._onKeyDown=this._onKeyDown.bind(this),this._onKeyUp=this._onKeyUp.bind(this),this._pauseListener=this._pauseListener.bind(this),this.setDeactivated(!1)};g.prototype={level:s,setDeactivated:function(e){this._deactivated!==e&&(this._deactivated=e,e?this._removeGameListeners():this._initializeGameListeners())},getInitialState:function(){return{currentStatus:v.CONTINUE,garbage:[],lastUpdated:null,keysPressed:{ESC:!1,LEFT:!1,RIGHT:!1,SPACE:!1,UP:!1},levelStartTime:null,objects:[],startTime:null}},initializeLevelAndStart:function(e){(e=void 0===e||e)||!this.state?(this._imagesArePreloaded=void 0,this.state=this.getInitialState(),this.state=p[this.level](this.state)):this.state.currentStatus=v.CONTINUE,this.state.levelStartTime=Date.now(),this.state.startTime||(this.state.startTime=this.state.levelStartTime),this._preloadImagesForLevel(function(){this.render(),this._initializeGameListeners(),this.update()}.bind(this))},pauseLevel:function(e){e&&(this.state.currentStatus=e),this.state.keysPressed.ESC=!1,this.state.lastUpdated=null,this._removeGameListeners(),window.addEventListener("keydown",this._pauseListener),this._drawPauseScreen()},_pauseListener:function(e){if(32===e.keyCode&&!this._deactivated){e.preventDefault();var t=this.state.currentStatus===v.WIN||this.state.currentStatus===v.FAIL;this.initializeLevelAndStart(t),window.removeEventListener("keydown",this._pauseListener)}},_drawPauseScreen:function(){var e;switch(this.state.currentStatus){case v.WIN:if(window.renderStatistics){var t=this._generateStatistics(new Date-this.state.startTime),n=this._shuffleArray(Object.keys(t));return void window.renderStatistics(this.ctx,n,n.map(function(e){return t[e]}))}e="Вы победили Газебо!\nУра!";break;case v.FAIL:e="Вы проиграли!";break;case v.PAUSE:e="Игра на паузе!\nНажмите Пробел, чтобы продолжить";break;case v.INTRO:e="Добро пожаловать!\nНажмите Пробел для начала игры"}this._drawMessage(e)},_generateStatistics:function(e){for(var t={"Вы":e},n=0;n<i.length;n++){var s=e+(3e3*Math.random()-1500);s<1e3&&(s=1e3),t[i[n]]=s}return t},_shuffleArray:function(e){for(var t=e.length-1;t>0;t--){var n=Math.floor(Math.random()*(t+1)),i=e[t];e[t]=e[n],e[n]=i}return e},_drawMessage:function(e){var t=this.ctx,n=function(e,n,i,s){t.beginPath(),t.moveTo(e,n),t.lineTo(e+10,n+s/2),t.lineTo(e,n+s),t.lineTo(e+i/2,n+s-10),t.lineTo(e+i,n+s),t.lineTo(e+i-10,n+s/2),t.lineTo(e+i,n),t.lineTo(e+i/2,n+10),t.lineTo(e,n),t.stroke(),t.closePath(),t.fill()};t.fillStyle="rgba(0, 0, 0, 0.7)",n(190,40,320,100),t.fillStyle="rgba(256, 256, 256, 1.0)",n(180,30,320,100),t.fillStyle="#000",t.font="16px PT Mono",e.split("\n").forEach(function(e,n){t.fillText(e,200,80+20*n)})},_preloadImagesForLevel:function(e){if(void 0===this._imagesArePreloaded&&(this._imagesArePreloaded=[]),this._imagesArePreloaded[this.level])e();else for(var t=Object.keys(f),n=t.length,i=this,s=function(t){var s=new Image(t.width,t.height);s.onload=function(){t.image=s,0==--n&&(i._imagesArePreloaded[i.level]=!0,e())},s.src=t.url},r=0;r<t.length;r++)s(f[t[r]])},updateObjects:function(e){var t=this.state.objects.filter(function(e){return e.type===r})[0];this.state.keysPressed.SHIFT&&(this.state.objects.push({direction:t.direction,height:window.GameConstants.Fireball.size,speed:window.GameConstants.Fireball.speed(!!(t.direction&c)),sprite:f[a],type:a,width:window.GameConstants.Fireball.size,x:t.direction&l?t.x+t.width:t.x-window.GameConstants.Fireball.size,y:t.y+t.height/2}),this.state.keysPressed.SHIFT=!1),this.state.garbage=[];var n=this.state.objects.filter(function(t){return m[t.type](t,this.state,e),t.state!==d||(this.state.garbage.push(t),!1)},this);this.state.objects=n},checkStatus:function(){if(this.state.currentStatus===v.CONTINUE){this.commonRules||(this.commonRules=[function(e){return e.objects.filter(function(e){return e.type===r})[0].state===d?v.FAIL:v.CONTINUE},function(e){return e.keysPressed.ESC?v.PAUSE:v.CONTINUE},function(e){return Date.now()-e.startTime>18e4?v.FAIL:v.CONTINUE}]);for(var e=this.commonRules.concat(y[this.level]),t=v.CONTINUE;t===v.CONTINUE&&e.length;)t=e.shift()(this.state);this.state.currentStatus=t}},setGameStatus:function(e){this.state.currentStatus!==e&&(this.state.currentStatus=e)},render:function(){this.ctx.clearRect(0,0,t,e),this.state.objects.forEach(function(e){if(e.sprite){var t=e.direction&c,n=f[e.type+(t?w:"")]||f[e.type];this.ctx.drawImage(n.image,e.x,e.y,e.width,e.height)}},this)},update:function(){this.state.lastUpdated||(this.state.lastUpdated=Date.now());var e=(Date.now()-this.state.lastUpdated)/10;switch(this.updateObjects(e),this.checkStatus(),this.state.currentStatus){case v.CONTINUE:this.state.lastUpdated=Date.now(),this.render(),requestAnimationFrame(function(){this.update()}.bind(this));break;case v.WIN:case v.FAIL:case v.PAUSE:case v.INTRO:this.pauseLevel()}},_onKeyDown:function(e){switch(e.keyCode){case 37:this.state.keysPressed.LEFT=!0;break;case 39:this.state.keysPressed.RIGHT=!0;break;case 38:this.state.keysPressed.UP=!0;break;case 27:this.state.keysPressed.ESC=!0}e.shiftKey&&(this.state.keysPressed.SHIFT=!0)},_onKeyUp:function(e){switch(e.keyCode){case 37:this.state.keysPressed.LEFT=!1;break;case 39:this.state.keysPressed.RIGHT=!1;break;case 38:this.state.keysPressed.UP=!1;break;case 27:this.state.keysPressed.ESC=!1}e.shiftKey&&(this.state.keysPressed.SHIFT=!1)},_initializeGameListeners:function(){window.addEventListener("keydown",this._onKeyDown),window.addEventListener("keyup",this._onKeyUp)},_removeGameListeners:function(){window.removeEventListener("keydown",this._onKeyDown),window.removeEventListener("keyup",this._onKeyUp)}},g.Verdict=v;var S=new g(document.querySelector(".demo"));return window.restartGame=function(e,t){f[r].url=e,f[r+w].url=t,S.initializeLevelAndStart(),S.setGameStatus(v.INTRO)},window.restartGame("img/wizard.gif","img/wizard-reversed.gif"),S}(),function(){var e=window.SERVER_URL||"https://js.dump.academy/code-and-magick",t=window.SERVER_URL_GET||e+"/data",n=window.SERVER_URL_POST||e,i=function(e,t){var n=new XMLHttpRequest;return n.responseType="json",n.addEventListener("load",function(){200===n.status?e(n.response):t(n.response)}),n.addEventListener("error",function(){t("Произошла ошибка соединения")}),n.addEventListener("timeout",function(){t("Запрос не успел выполниться за "+n.timeout+"мс")}),n.timeout=1e4,n};window.backend={save:function(e,t,s){var r=i(t,s);r.open("POST",n),r.send(e)},load:function(e,n){var s=i(e,n);s.open("GET",t),s.send()}}}(),window.renderStatistics=function(e,t,n){var i=function(t,n,i,s){e.beginPath(),e.moveTo(t,n),e.lineTo(t+10,n+s/2),e.lineTo(t,n+s),e.lineTo(t+i/2,n+s-10),e.lineTo(t+i,n+s),e.lineTo(t+i-10,n+s/2),e.lineTo(t+i,n),e.lineTo(t+i/2,n+10),e.lineTo(t,n),e.stroke(),e.closePath(),e.fill()};e.fillStyle="rgba(0, 0, 0, 0.7)",i(110,20,420,270),e.fillStyle="rgba(256, 256, 256, 1.0)",i(100,10,420,270),e.fillStyle="#000",e.font="16px PT Mono",e.fillText("Ура вы победили!",120,40),e.fillText("Список результатов:",120,60);var s=-1,r=1/0;n.forEach(function(e){e>s&&(s=e),e<r&&(r=e)});for(var a=150/(s-(r=0)),o=0;o<n.length;o++){var d=t[o],c=n[o],l=a*(c-r);e.fillText(c.toFixed(0),140+90*o,240-l),e.fillStyle="Вы"===d?"rgba(255, 0, 0, 1)":["rgba(0,0,",(5*Math.random()*50).toFixed(0),",",Math.random().toFixed(1),")"].join(""),e.fillRect(140+90*o,250-l,40,l),e.fillStyle="#000",e.fillText(d,140+90*o,270)}},function(){var e=document.querySelector(".setup"),t=document.querySelector(".setup-wizard-form"),n=document.querySelector(".setup-open"),i=document.querySelector(".setup-close");n.addEventListener("click",function(){e.classList.remove("hidden")}),i.addEventListener("click",function(){e.classList.add("hidden")}),t.addEventListener("submit",function(){e.classList.add("hidden")})}(),function(){var e=document.querySelector(".setup-artifacts-shop"),t=null;e.addEventListener("dragstart",function(e){return"img"===e.target.tagName.toLowerCase()&&(t=e.target,e.dataTransfer.setData("text",e.target.alt)),!1});var n=document.querySelector(".setup-artifacts");n.addEventListener("drop",function(e){return e.target.style.backgroundColor="",e.target.appendChild(t),!1}),n.addEventListener("dragenter",function(e){e.target.style.backgroundColor="yellow",e.preventDefault()}),n.addEventListener("dragover",function(e){return e.preventDefault(),!1}),n.addEventListener("dragleave",function(e){e.target.style.backgroundColor="",e.preventDefault()})}(),function(){var e=document.querySelector(".setup"),t=e.querySelector(".upload");t.addEventListener("mousedown",function(n){n.preventDefault();var i={x:n.clientX,y:n.clientY},s=!1,r=function(t){t.preventDefault(),s=!0;var n=i.x-t.clientX,r=i.y-t.clientY;i={x:t.clientX,y:t.clientY},e.style.top=e.offsetTop-r+"px",e.style.left=e.offsetLeft-n+"px"},a=function(e){if(e.preventDefault(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",a),s){var n=function(e){e.preventDefault(),t.removeEventListener("click",n)};t.addEventListener("click",n)}};document.addEventListener("mousemove",r),document.addEventListener("mouseup",a)})}(),function(){var e=["red","black","blue","yellow","green"],t=["rgb(146, 100, 161)","rgb(215, 210, 55)","rgb(241, 43, 107)","rgb(101, 137, 164)","rgb(0, 0, 0)","rgb(215, 210, 55)","rgb(56, 159, 117)","rgb(241, 43, 107)"],n=function(e){return e[Math.floor(Math.random()*e.length)]},i=function(e){this.setName(e.username||e.name),this.coatColor=e.coatColor,this.eyesColor=e.eyeColor,this.fireballColor=e.fireballColor,this.artifacts=e.artifacts};i.prototype={setName:function(e){if(!e||0===e.length||e.length>30)throw new Error("Недопустимое значение имени мага: "+e);return this.name=e,this.onChange(this),e},changeCoatColor:function(){var e=n(t);return this.coatColor=e,this.onChange(this),e},changeEyesColor:function(){var t=n(e);return this.eyesColor=t,this.onChange(this),t},onChange:function(e){return e}},window.Wizard=i}(),function(){var e=document.querySelector('input[name="avatar"]'),t=document.querySelector(".setup-wizard"),n=t.querySelector(".wizard-coat"),i=document.querySelector(".setup-user-name"),s=document.querySelector(".setup-wizard-eye"),r=document.querySelector(".setup-wizard-coat"),a=new window.Wizard({username:i.value});e.addEventListener("change",function(e){var t=e.target,n=e.target.files[0];n&&(n.type.indexOf("image/")>=0?t.setCustomValidity(""):t.setCustomValidity("Аватар должен быть картинкой"))}),i.addEventListener("input",function(){i.value.length<2?i.setCustomValidity("Имя должно состоять минимум из 2-х символов"):(i.setCustomValidity(""),a.setName(i.value))}),n.addEventListener("click",function(){var e=a.changeCoatColor();n.style.fill=e,r.value=e});var o=t.querySelector(".wizard-eyes");o.addEventListener("click",function(){var e=a.changeEyesColor();o.style.fill=e,s.value=e}),document.querySelector(".setup-wizard-form").addEventListener("submit",function(e){i.validity.valid?(window.backend.save(new FormData(e.target),function(){var e=document.querySelector("svg").cloneNode(!0);e.querySelector("#wizard-coat").style.fill=a.coatColor,e.querySelector("#wizard-eyes").style.fill=a.eyesColor;var t=window.svg2base64(e);e.querySelector("#wizard").setAttribute("transform","translate(62, 0) scale(-1, 1)");var n=window.svg2base64(e);window.restartGame(t,n)},function(e){window.console.log(e)}),e.preventDefault()):e.preventDefault()}),window.myWizard=a}(),window.popup=new function(){this.element=document.createElement("div"),this.element.classList.add("popup"),this.element.style.position="absolute",this.element.style.zIndex=100,this.hide=function(){this.element.style.display="none"},this.show=function(){this.element.style.display="block"},this.changePosition=function(e,t){this.element.style.left=e+"px",this.element.style.top=t+"px"},this.setContent=function(e){this.element.innerHTML="",this.element.appendChild(e)},this.hide(),document.body.appendChild(this.element)},function(){var e=document.querySelector("#similar-wizard-template"),t=document.querySelector(".setup-similar"),n=document.querySelector(".setup-similar-list");window.render=function(i){n.innerHTML="",i.slice(0,4).forEach(function(t){var i,s,r,a,o,d,c,l=(i=t,s=e.content.cloneNode(!0),(r=s.querySelector(".wizard")).querySelector(".wizard-coat").style.fill=i.coatColor,r.querySelector(".wizard-eyes").style.fill=i.eyesColor,s.querySelector(".setup-similar-label").innerText=i.name,s);t.artifacts&&(a=l.querySelector(".wizard"),o=function(){return e=t,(n=document.createElement("div")).innerHTML=e.artifacts.map(function(e){return e.name}).join("<br>"),n;var e,n},d=function(e){window.popup.changePosition(e.pageX+10,e.pageY+10)},c=function(){window.popup.hide(),a.removeEventListener("mousemove",d),a.removeEventListener("mouseleave",c)},a.addEventListener("mouseenter",function(){window.popup.setContent(o()),window.popup.show(),a.addEventListener("mousemove",d),a.addEventListener("mouseleave",c)})),n.appendChild(l)}),t.classList.remove("hidden")}}(),function(){var e=[],t=function(e){var t=0;return e.colorCoat===window.myWizard.coatColor&&(t+=2),e.colorEyes===window.myWizard.eyesColor&&(t+=1),t},n=function(e,n){var i,s,r=t(n)-t(e);return 0===r?(i=e.name,s=n.name,i>s?1:i<s?-1:0):r},i=function(){window.render(e.sort(n))};window.myWizard.onChange=function(){i()};window.backend.load(function(t){e=t.data.map(function(e){return new window.Wizard(e)}),i()},function(e){var t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)})}(),window.svg2base64=function(e){var t=(new XMLSerializer).serializeToString(e);return"data:image/svg+xml;charset=utf-8;base64,"+window.btoa(t)},function(){var e=document.querySelector(".upload input[type=file]"),t=document.querySelector(".setup-user-pic");e.addEventListener("change",function(){var n=e.files[0];if(n){var i=new FileReader;i.addEventListener("load",function(){t.src=i.result}),i.readAsDataURL(n)}})}();
